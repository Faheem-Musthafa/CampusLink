rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the document owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Get user document data (cached per request)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user is an admin (with safe null handling)
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user has verified status
    function isVerified() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verificationStatus == 'approved';
    }
    
    // Check if user has a specific role
    function hasRole(role) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // Check if user is alumni
    function isAlumni() {
      return hasRole('alumni');
    }
    
    // ============================================
    // USER MANAGEMENT
    // ============================================
    
    // Users collection - Core user accounts
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // Users can only create their own document during signup
      allow create: if isOwner(userId);
      
      // Users can update their own profile, admins can update any
      allow update: if isOwner(userId) || isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // User profiles - Extended profile information
    match /profiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // VERIFICATION SYSTEM
    // ============================================
    
    // Verified Alumni Database - Pre-populated records from institution
    match /verifiedAlumni/{admissionNo} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      
      // Allow admins to update any record
      // Allow authenticated users to claim unclaimed records
      allow update: if isAdmin() || 
        (isAuthenticated() && 
          (resource.data.get('isUsed', false) == false));
      
      allow delete: if isAdmin();
    }
    
    // Email OTPs for aspirant verification
    match /emailOTPs/{email} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Verification Requests
    match /verificationRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // ============================================
    // JOBS & APPLICATIONS
    // ============================================
    
    // Job Postings
    match /jobPostings/{jobId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.resource.data.postedBy == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        (resource.data.postedBy == request.auth.uid || isAdmin());
      
      allow delete: if isAuthenticated() && 
        (resource.data.postedBy == request.auth.uid || isAdmin());
    }
    
    // Jobs collection (alternate/legacy name)
    match /jobs/{jobId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.postedBy == request.auth.uid;
      allow update: if isAuthenticated() && 
        (resource.data.postedBy == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
        (resource.data.postedBy == request.auth.uid || isAdmin());
    }
    
    // Job Applications
    match /jobApplications/{applicationId} {
      allow read: if isAuthenticated() && 
        (resource.data.applicantId == request.auth.uid || 
         resource.data.employerId == request.auth.uid ||
         isAdmin());
      
      allow create: if isAuthenticated() && 
        request.resource.data.applicantId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        (resource.data.applicantId == request.auth.uid || 
         resource.data.employerId == request.auth.uid ||
         isAdmin());
      
      allow delete: if isAuthenticated() && 
        (resource.data.applicantId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // MENTORSHIP
    // ============================================
    
    // Mentorship Requests (main collection)
    match /mentorshipRequests/{requestId} {
      allow read: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid || 
         resource.data.mentorId == request.auth.uid ||
         isAdmin());
      
      allow create: if isAuthenticated() && 
        request.resource.data.studentId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid || 
         resource.data.mentorId == request.auth.uid ||
         isAdmin());
      
      allow delete: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid || isAdmin());
    }
    
    // Mentorships collection (alternate/legacy name)
    match /mentorships/{mentorshipId} {
      allow read: if isAuthenticated() && 
        (resource.data.menteeId == request.auth.uid || 
         resource.data.mentorId == request.auth.uid ||
         isAdmin());
      allow create: if isAuthenticated() && 
        request.resource.data.menteeId == request.auth.uid;
      allow update: if isAuthenticated() && 
        (resource.data.menteeId == request.auth.uid || 
         resource.data.mentorId == request.auth.uid ||
         isAdmin());
      allow delete: if isAuthenticated() && 
        (resource.data.menteeId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // MESSAGING / CHAT
    // ============================================
    
    // Conversations
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participants;
      
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      allow delete: if false;
      
      // Typing indicators subcollection
      match /typing/{typingId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid ||
         isAdmin());
      
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
      
      allow delete: if isAuthenticated() && 
        resource.data.senderId == request.auth.uid;
    }
    
    // Blocked Users
    match /blockedUsers/{blockId} {
      allow read: if isAuthenticated() && 
        (resource.data.blockerId == request.auth.uid || 
         resource.data.blockedUserId == request.auth.uid ||
         isAdmin());
      
      allow create: if isAuthenticated() && 
        request.resource.data.blockerId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
        resource.data.blockerId == request.auth.uid;
      
      allow update: if false;
    }
    
    // ============================================
    // SOCIAL FEED / POSTS
    // ============================================
    
    // Posts
    match /posts/{postId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.resource.data.authorId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
      
      allow delete: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
    }
    
    // Post Likes
    match /postLikes/{likeId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Post Comments
    match /postComments/{commentId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.resource.data.authorId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        resource.data.authorId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
        (resource.data.authorId == request.auth.uid || isAdmin());
    }
    
    // Comment Likes
    match /commentLikes/{likeId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      allow update: if false;
      
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // NOTIFICATIONS
    // ============================================
    
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // REPORTS & MODERATION
    // ============================================
    
    // User Reports
    match /userReports/{reportId} {
      allow read: if isAdmin();
      
      allow create: if isAuthenticated() && 
        request.resource.data.reportedBy == request.auth.uid;
      
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // Chat Reports
    match /chatReports/{reportId} {
      allow read: if isAdmin();
      
      allow create: if isAuthenticated() && 
        request.resource.data.reporterId == request.auth.uid;
      
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // Reports (legacy collection)
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // ============================================
    // ADMIN
    // ============================================
    
    // Admin Activity Logs - Immutable audit trail
    match /adminActivityLogs/{logId} {
      allow read: if isAdmin();
      // Allow any authenticated user to create logs (logging happens after admin actions)
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // Platform Configuration
    match /config/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // LINK PREVIEWS (Cache)
    // ============================================
    
    match /linkPreviews/{previewId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
  }
}
